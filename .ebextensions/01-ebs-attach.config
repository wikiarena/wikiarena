commands:
  01_attach_ebs_volume:
    command: |
      #!/bin/bash
      set -e
      exec > /var/log/ebs-attach-command.log 2>&1
      
      echo "=== EBS Volume Attachment Command Started at $(date) ==="
      
      # Get EBS volume ID from environment variable
      EBS_VOLUME_ID=$(/opt/elasticbeanstalk/bin/get-config environment -k EBS_VOLUME_ID)
      AWS_REGION=$(/opt/elasticbeanstalk/bin/get-config environment -k AWS_DEFAULT_REGION)
      
      if [ -z "$EBS_VOLUME_ID" ]; then
          echo "ERROR: EBS_VOLUME_ID not set"
          exit 1
      fi
      
      echo "EBS Volume ID: $EBS_VOLUME_ID"
      echo "AWS Region: $AWS_REGION"
      
      # Get instance ID from metadata
      INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
      echo "Instance ID: $INSTANCE_ID"
      
      # Check if volume is already attached
      CURRENT_ATTACHMENT=$(aws ec2 describe-volumes \
          --volume-ids "$EBS_VOLUME_ID" \
          --region "$AWS_REGION" \
          --query 'Volumes[0].Attachments[?InstanceId==`'$INSTANCE_ID'`].State' \
          --output text 2>/dev/null || echo "")
      
      if [ "$CURRENT_ATTACHMENT" = "attached" ]; then
          echo "EBS volume already attached to this instance"
          exit 0
      fi
      
      # Wait for volume to be available
      echo "Waiting for EBS volume to be available..."
      for i in {1..30}; do
          VOLUME_STATE=$(aws ec2 describe-volumes \
              --volume-ids "$EBS_VOLUME_ID" \
              --region "$AWS_REGION" \
              --query 'Volumes[0].State' \
              --output text)
          
          if [ "$VOLUME_STATE" = "available" ]; then
              echo "EBS volume is available"
              break
          fi
          
          if [ $i -eq 30 ]; then
              echo "ERROR: EBS volume not available after 5 minutes"
              exit 1
          fi
          
          echo "Volume state: $VOLUME_STATE, waiting..."
          sleep 10
      done
      
      # Attach the volume
      echo "Attaching EBS volume $EBS_VOLUME_ID to instance $INSTANCE_ID..."
      aws ec2 attach-volume \
          --volume-id "$EBS_VOLUME_ID" \
          --instance-id "$INSTANCE_ID" \
          --device "/dev/sdf" \
          --region "$AWS_REGION"
      
      # Wait for attachment
      echo "Waiting for volume attachment..."
      for i in {1..30}; do
          ATTACHMENT_STATE=$(aws ec2 describe-volumes \
              --volume-ids "$EBS_VOLUME_ID" \
              --region "$AWS_REGION" \
              --query 'Volumes[0].Attachments[0].State' \
              --output text 2>/dev/null || echo "")
          
          if [ "$ATTACHMENT_STATE" = "attached" ]; then
              echo "EBS volume successfully attached"
              break
          fi
          
          if [ $i -eq 30 ]; then
              echo "ERROR: Volume attachment failed after 5 minutes"
              exit 1
          fi
          
          echo "Attachment state: $ATTACHMENT_STATE, waiting..."
          sleep 10
      done
      
      echo "=== EBS Volume Attachment Command Completed at $(date) ==="
    ignoreErrors: false